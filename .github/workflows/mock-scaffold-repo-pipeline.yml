# Mock: Scaffold New GitHub Repo + Actions Pipeline (Terraform, Python). Logs progress with emojis to Port.
name: "[Mock] Scaffold Repo + Pipeline"

on:
  workflow_dispatch:
    inputs:
      port_context:
        description: Port run context (runId, etc.) for logging
        required: true
        type: string
      repo_name:
        required: true
        type: string
      visibility:
        required: false
        type: string
        default: "private"
      include_terraform:
        required: false
        type: boolean
        default: true
      include_python:
        required: false
        type: boolean
        default: true
      application:
        required: false
        type: string

jobs:
  mock:
    runs-on: ubuntu-latest
    steps:
      - name: Mock scaffold and report to Port
        env:
          PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
          PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
          PORT_BASE_URL: https://api.us.getport.io
          PORT_CONTEXT_JSON: ${{ inputs.port_context }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          PORT_RUN_ID=$(echo "$PORT_CONTEXT_JSON" | jq -r '.runId // empty')
          if [[ -z "$PORT_RUN_ID" ]]; then echo "::warning::No runId in port_context"; exit 0; fi
          if [[ -z "${PORT_CLIENT_ID:-}" || -z "${PORT_CLIENT_SECRET:-}" ]]; then echo "::warning::PORT_CLIENT_ID/SECRET not set"; exit 0; fi
          token=$(curl -sS -X POST "$PORT_BASE_URL/v1/auth/access_token" -H "Content-Type: application/json" -d "{\"clientId\":\"$PORT_CLIENT_ID\",\"clientSecret\":\"$PORT_CLIENT_SECRET\"}" | jq -r '.accessToken')
          port_log() { curl -sS -X POST "$PORT_BASE_URL/v1/actions/runs/$PORT_RUN_ID/logs" -H "Content-Type: application/json" -H "Authorization: Bearer $token" -d "$(jq -nc --arg msg "$1" '{message: $msg}')" >/dev/null || true; }
          port_patch() { curl -sS -X PATCH "$PORT_BASE_URL/v1/actions/runs/$PORT_RUN_ID" -H "Content-Type: application/json" -H "Authorization: Bearer $token" -d "$1" >/dev/null || true; }
          port_log "ğŸš€ Mock: Scaffolding new GitHub repo + pipeline..."
          port_log "ğŸ“‹ Repo: ${{ inputs.repo_name }} | Visibility: ${{ inputs.visibility }} | Terraform: ${{ inputs.include_terraform }} | Python: ${{ inputs.include_python }}"
          port_log "â³ Mock: Creating repository (simulated)..."
          port_log "ğŸ“œ Mock: Adding Terraform/Python workflows (simulated)..."
          port_log "âœ… Mock: Repo and pipeline scaffolded successfully (demo only)."
          port_patch "$(jq -nc --arg url "$RUN_URL" '{link: [$url], status: "SUCCESS"}')"
