name: Handle degraded rule result

on:
  workflow_dispatch:
    inputs:
      rule_result_id:
        description: "The rule result entity identifier"
        required: true
        type: string
      rule_id:
        description: "The rule entity identifier"
        required: true
        type: string
      entity_id:
        description: "The entity identifier that failed the rule"
        required: true
        type: string
      run_id:
        description: "Port action run ID"
        required: true
        type: string

jobs:
  print_inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Log message to Port run
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.us.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.run_id }}
          logMessage: "Starting scorecard failure handling for rule result: ${{ inputs.rule_result_id }}"
      
      - name: Get rule entity information
        id: get_rule
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.us.getport.io
          operation: GET
          blueprint: "_rule"
          identifier: ${{ inputs.rule_id }}
      
      - name: Get entity information
        id: get_entity
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.us.getport.io
          operation: GET
          blueprint: s3
          identifier: ${{ inputs.entity_id }}
      
      - name: Extract rule properties and validate
        id: extract_rule
        run: |
          # The Port GitHub Action outputs the entity as a JSON string
          RULE_ENTITY_JSON="${{ steps.get_rule.outputs.entity }}"
          
          if [ -z "$RULE_ENTITY_JSON" ] || [ "$RULE_ENTITY_JSON" == "null" ]; then
            echo "Error: Rule entity not found or empty"
            exit 1
          fi
          
          # Extract rule properties using jq
          RULE_DESCRIPTION=$(echo "$RULE_ENTITY_JSON" | jq -r '.properties.description // ""')
          RULE_TEMPLATE=$(echo "$RULE_ENTITY_JSON" | jq -r '.properties.template // ""')
          RULE_TEAM=$(echo "$RULE_ENTITY_JSON" | jq -r '.team // ""')
          RULE_TITLE=$(echo "$RULE_ENTITY_JSON" | jq -r '.title // .identifier // ""')
          RULE_IDENTIFIER=$(echo "$RULE_ENTITY_JSON" | jq -r '.identifier // ""')
          
          # Validate that description and template are not null/empty
          if [ -z "$RULE_DESCRIPTION" ] || [ "$RULE_DESCRIPTION" == "null" ]; then
            echo "VALIDATION_FAILED=true" >> $GITHUB_OUTPUT
            echo "ERROR_MESSAGE=Rule description is missing or null for rule: $RULE_IDENTIFIER" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -z "$RULE_TEMPLATE" ] || [ "$RULE_TEMPLATE" == "null" ]; then
            echo "VALIDATION_FAILED=true" >> $GITHUB_OUTPUT
            echo "ERROR_MESSAGE=Rule template is missing or null for rule: $RULE_IDENTIFIER" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "VALIDATION_FAILED=false" >> $GITHUB_OUTPUT
          echo "Rule Description: $RULE_DESCRIPTION"
          echo "Rule Template: $RULE_TEMPLATE"
          echo "Rule Team: $RULE_TEAM"
          
          # Set outputs for use in subsequent steps
          echo "description=$RULE_DESCRIPTION" >> $GITHUB_OUTPUT
          echo "template=$RULE_TEMPLATE" >> $GITHUB_OUTPUT
          echo "team=$RULE_TEAM" >> $GITHUB_OUTPUT
          echo "title=$RULE_TITLE" >> $GITHUB_OUTPUT
          echo "identifier=$RULE_IDENTIFIER" >> $GITHUB_OUTPUT
      
      - name: Log validation error and exit
        if: steps.extract_rule.outputs.VALIDATION_FAILED == 'true'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.us.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.run_id }}
          logMessage: ${{ steps.extract_rule.outputs.ERROR_MESSAGE }}
      
      - name: Fail if validation failed
        if: steps.extract_rule.outputs.VALIDATION_FAILED == 'true'
        run: |
          echo "Validation failed. Exiting workflow."
          exit 1
      
      - name: Generate template content
        if: steps.extract_rule.outputs.VALIDATION_FAILED == 'false'
        id: generate_template
        run: |
          # Get entity information
          ENTITY_JSON="${{ steps.get_entity.outputs.entity }}"
          TITLE=$(echo "$ENTITY_JSON" | jq -r '.title // .identifier // ""')
          
          # Get rule information
          RULE_TITLE="${{ steps.extract_rule.outputs.title }}"
          RULE_IDENTIFIER="${{ steps.extract_rule.outputs.identifier }}"
          RULE_DESCRIPTION="${{ steps.extract_rule.outputs.description }}"
          RULE_TEMPLATE="${{ steps.extract_rule.outputs.template }}"
          
          # Use rule title if available, otherwise use identifier
          RULE_DISPLAY_NAME="${RULE_TITLE:-$RULE_IDENTIFIER}"
          
          # Generate the template content by replacing placeholders using Python
          GENERATED_CONTENT=$(echo "$RULE_TEMPLATE" | RULE_NAME="$RULE_DISPLAY_NAME" ENTITY_NAME="$ENTITY_TITLE" DESCRIPTION="$RULE_DESCRIPTION" python3 << 'PYEOF'
          import os
          import sys
          template = sys.stdin.read()
          rule_name = os.environ.get('RULE_NAME', '')
          entity_name = os.environ.get('ENTITY_NAME', '')
          description = os.environ.get('DESCRIPTION', '')
          result = template.replace('{{ Rule }}', rule_name).replace('{{ Entity }}', entity_name).replace('{{ Description }}', description)
          print(result, end='')
          PYEOF
          )
          
          echo "Generated template content:"
          echo "$GENERATED_CONTENT"
          
          # Set output for use in subsequent steps (using multiline output)
          {
            echo "content<<EOF"
            echo "$GENERATED_CONTENT"
            echo "EOF"
          } >> $GITHUB_OUTPUT
      
      - name: Create scorecard task entity
        if: steps.extract_rule.outputs.VALIDATION_FAILED == 'false'
        id: create_task
        run: |
          # Get the team identifier from the rule entity (team can be an array or single value)
          RULE_ENTITY_JSON="${{ steps.get_rule.outputs.entity }}"
          TEAM_VALUE=$(echo "$RULE_ENTITY_JSON" | jq -r '.team // ""')
          
          # Extract first team identifier if it's an array, otherwise use the value
          if [ -n "$TEAM_VALUE" ] && [ "$TEAM_VALUE" != "null" ]; then
            TEAM_IDENTIFIER=$(echo "$TEAM_VALUE" | jq -r 'if type == "array" then .[0] else . end // ""')
          else
            TEAM_IDENTIFIER=""
          fi
          
          # Get the generated template content
          RESOLUTION_CONTENT="${{ steps.generate_template.outputs.content }}"
          
          # Generate a title for the task
          RULE_TITLE="${{ steps.extract_rule.outputs.title }}"
          RULE_IDENTIFIER="${{ steps.extract_rule.outputs.identifier }}"
          ENTITY_JSON="${{ steps.get_entity.outputs.entity }}"
          ENTITY_TITLE=$(echo "$ENTITY_JSON" | jq -r '.title // .identifier // ""')
          
          # Use rule title if available, otherwise use identifier
          RULE_DISPLAY="${RULE_TITLE:-$RULE_IDENTIFIER}"
          ENTITY_DISPLAY="${ENTITY_TITLE:-${{ inputs.sentity_id }}}"
          TASK_TITLE="Task: $RULE_DISPLAY - $ENITY_DISPLAY"
          
          # Prepare properties JSON
          PROPERTIES_JSON=$(jq -n \
            --arg resolution "$RESOLUTION_CONTENT" \
            '{resolution: $resolution}')
          
          # Prepare relations JSON - build object conditionally
          RELATIONS_JSON=$(jq -n \
            --arg rule_id "${{ inputs.rule_id }}" \
            --arg entity_id "${{ inputs.entity_id }}" \
            --arg team_id "$TEAM_IDENTIFIER" \
            '{
              rule: $rule_id,
              s_3: $entity_id
            } + (if $team_id != "" and $team_id != "null" then {team: $team_id} else {} end)')
          
          echo "Creating scorecard task entity:"
          echo "  Title: $TASK_TITLE"
          echo "  Rule: ${{ inputs.rule_id }}"
          echo "  Entity: ${{ inputs.entity_id }}"
          echo "  Team: $TEAM_IDENTIFIER"
          echo "  Properties: $PROPERTIES_JSON"
          echo "  Relations: $RELATIONS_JSON"
          
          # Set outputs
          echo "task_title=$TASK_TITLE" >> $GITHUB_OUTPUT
          echo "properties=$PROPERTIES_JSON" >> $GITHUB_OUTPUT
          echo "relations=$RELATIONS_JSON" >> $GITHUB_OUTPUT
      
      - name: Upsert scorecard task entity
        if: steps.extract_rule.outputs.VALIDATION_FAILED == 'false'
        id: upsert_task
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.us.getport.io
          operation: UPSERT
          blueprint: scorecard_tasks
          title: ${{ steps.create_task.outputs.task_title }}
          properties: ${{ steps.create_task.outputs.properties }}
          relations: ${{ steps.create_task.outputs.relations }}
          runId: ${{ inputs.run_id }}
      
      - name: Log task creation success
        if: steps.extract_rule.outputs.VALIDATION_FAILED == 'false'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.us.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.run_id }}
          logMessage: "Successfully created scorecard task: ${{ steps.create_task.outputs.task_title }}"
